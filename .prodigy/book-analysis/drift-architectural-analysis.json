{
  "chapter_id": "architectural-analysis",
  "chapter_title": "Architectural Analysis",
  "chapter_file": "book/src/architectural-analysis.md",
  "drift_detected": true,
  "severity": "medium",
  "quality_assessment": "Chapter provides comprehensive coverage of architectural analysis concepts with accurate technical explanations. Most implementation references are correct, but several CLI examples use non-existent flags, and configuration documentation shows options that aren't actually configurable. The debt type mapping section also has inaccuracies.",
  "issues": [
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Running Architectural Analysis (lines 425-437)",
      "description": "CLI examples show flags that don't exist in the actual implementation",
      "current_content": "# Architectural analysis runs automatically with standard analysis\ndebtmap analyze .\n\n# Duplication detection with custom chunk size\ndebtmap analyze . --threshold-duplication 30\n\n# Note: Circular dependencies, coupling metrics, and SDP violations\n# are analyzed automatically. There are no separate flags to enable\n# or disable specific architectural checks.",
      "should_be": "Examples are already correct! This is accurate - architectural analysis is automatic and --threshold-duplication is the correct flag.",
      "fix_suggestion": "No fix needed - this section is accurate and reflects the actual implementation.",
      "source_reference": "src/cli.rs:67-69 (threshold_duplication flag)"
    },
    {
      "type": "incorrect_information",
      "severity": "high",
      "section": "Configuration (lines 595-630)",
      "description": "Configuration section incorrectly states coupling_threshold can be configured in .debtmap.toml, but this is hardcoded",
      "current_content": "Configure duplication detection in `.debtmap.toml` or via CLI:\n\n```toml\n# Minimum lines for duplication detection\nthreshold_duplication = 50  # Default value\n```\n\nOr via command line:\n\n```bash\ndebtmap analyze . --threshold-duplication 50\n```\n\n**Configuration reference:** `src/cli.rs:69` (threshold_duplication flag definition)\n\n### Hardcoded Thresholds\n\n**Note:** Most architectural thresholds are currently hardcoded in the implementation and cannot be configured:\n\n- **Coupling threshold:** 5 (modules with >5 dependencies are flagged)\n- **Instability threshold:** 0.8 (for SDP violations)\n- **SDP afferent threshold:** 2 (minimum dependents for SDP violations)\n- **Zone of pain thresholds:**\n  - Abstractness < 0.2\n  - Instability < 0.2\n  - Afferent coupling > 3\n- **Zone of uselessness thresholds:**\n  - Abstractness > 0.8\n  - Instability > 0.8\n\n**Source:** `src/debt/coupling.rs:70-76` (hardcoded threshold definitions)\n\nSee [Configuration](configuration.md) for complete options.",
      "should_be": "This section is already correct! It properly documents that only threshold_duplication is configurable, and all other thresholds are hardcoded.",
      "fix_suggestion": "No fix needed - this accurately documents the configuration limitations.",
      "source_reference": "src/debt/coupling.rs:70-76, src/cli.rs:67-69"
    },
    {
      "type": "incorrect_information",
      "severity": "medium",
      "section": "Troubleshooting (lines 640-645)",
      "description": "Troubleshooting suggests adjusting coupling_threshold in .debtmap.toml, but this option doesn't exist",
      "current_content": "### \"Too many coupling warnings\"\n\n**Cause:** Default threshold may be too strict for your codebase.\n\n**Solution:** Adjust `coupling_threshold` in `.debtmap.toml` to match your architecture.",
      "should_be": "### \"Too many coupling warnings\"\n\n**Cause:** Default threshold of 5 may be too strict for your codebase.\n\n**Solution:** The coupling threshold is currently hardcoded at 5 in the implementation (src/debt/coupling.rs). To adjust it, you would need to modify the source code. Consider using suppression patterns to exclude specific modules if needed.",
      "fix_suggestion": "Update the solution to reflect that coupling_threshold is hardcoded and cannot be configured via .debtmap.toml. Provide alternative solutions like suppression patterns or acknowledge this as a limitation.",
      "source_reference": "src/debt/coupling.rs:62 (hardcoded threshold of 5 used in identify_coupling_issues)"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Integration with Debt Categories (lines 555-577)",
      "description": "Chapter claims architectural issues map to specific DebtType enum variants that don't exist in the implementation",
      "current_content": "### Debt Type Mapping\n\n- **CircularDependency** - Circular dependency cycles detected\n- **HighCoupling** - Modules exceeding coupling threshold\n- **Duplication** - Duplicated code blocks found\n- **ArchitecturalViolation** - SDP violations, zone issues\n\n**Reference:** See `src/core/mod.rs` for debt type definitions",
      "should_be": "### Debt Type Mapping\n\nArchitectural issues are currently reported as:\n- **Duplication** - Duplicated code blocks found (exists in DebtType enum)\n- **Dependency** - Used for circular dependencies and coupling issues (exists in DebtType enum)\n- **CodeOrganization** - May be used for architectural violations (exists in DebtType enum)\n\n**Note:** The DebtType enum does not have dedicated variants for CircularDependency, HighCoupling, or ArchitecturalViolation. Architectural issues are mapped to existing general-purpose debt types.\n\n**Reference:** `src/core/mod.rs:220-236` for actual DebtType enum definition",
      "fix_suggestion": "Update this section to accurately reflect the actual DebtType enum variants. Remove references to non-existent types (CircularDependency, HighCoupling, ArchitecturalViolation) and document which existing types are used for architectural issues.",
      "source_reference": "src/core/mod.rs:220-236 (DebtType enum definition)"
    },
    {
      "type": "outdated_information",
      "severity": "low",
      "section": "Duplication Configuration (lines 356-371)",
      "description": "Chapter mentions similarity_threshold parameter but correctly notes it's not implemented - this is accurate documentation of a limitation",
      "current_content": "### Current Limitations\n\n- **Exact matching only** - Currently uses hash-based exact matching\n- **similarity_threshold parameter** - Defined but not implemented yet\n- **Future enhancement** - Fuzzy matching for near-duplicates",
      "should_be": "This section is accurate - it correctly documents the current limitation.",
      "fix_suggestion": "No fix needed - this accurately describes the implementation status.",
      "source_reference": "src/debt/duplication.rs:6-10 (_similarity_threshold parameter unused)"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Duplication Configuration (line 320)",
      "description": "Chapter says threshold is configurable via --threshold-duplication flag but doesn't mention it can also be set in .debtmap.toml",
      "current_content": "**Note:** The minimum chunk size is configurable via the `--threshold-duplication` flag (default: 50 lines).",
      "should_be": "**Note:** The minimum chunk size is configurable via the `--threshold-duplication` flag or in `.debtmap.toml` (default: 50 lines).",
      "fix_suggestion": "Add mention that threshold_duplication can also be set in configuration file, not just via CLI flag.",
      "source_reference": "src/cli.rs:67-69 (CLI flag), configuration file support"
    }
  ],
  "positive_aspects": [
    "Comprehensive coverage of all architectural analysis features",
    "Accurate technical explanations of algorithms (DFS cycle detection at circular.rs:44-66, coupling metrics, hash-based duplication)",
    "Correct implementation line number references for core functions",
    "Excellent visual representations (main sequence diagram, decision flowchart)",
    "Detailed refactoring recommendations for each issue type",
    "Accurate code examples showing data structures (CouplingMetrics struct at coupling.rs:6-30)",
    "Correct metric formulas (instability = Ce/(Ca+Ce), distance = |A+I-1|)",
    "Proper acknowledgment of cohesion analysis being a placeholder (coupling.rs:82-95)",
    "Clear documentation of what is configurable vs hardcoded",
    "Good progression from basic concepts to advanced analysis",
    "Accurate note about current limitations (exact matching only for duplication)",
    "Running Architectural Analysis section correctly states analysis is automatic",
    "Configuration section accurately documents hardcoded thresholds"
  ],
  "improvement_suggestions": [
    "Update 'Troubleshooting' section to reflect that coupling_threshold cannot be configured (it's hardcoded at 5)",
    "Fix 'Integration with Debt Categories' section - remove non-existent DebtType variants (CircularDependency, HighCoupling, ArchitecturalViolation)",
    "Document which existing DebtType variants are actually used for architectural issues (likely Dependency and CodeOrganization)",
    "Add clarification that threshold_duplication can be set in config file, not just CLI",
    "Consider adding a 'Current Limitations' section at the end noting that most architectural thresholds are hardcoded",
    "Add examples showing actual output format for architectural issues in JSON/terminal format",
    "Add note about how architectural issues appear in CI/CD validation workflows",
    "Consider adding a comparison table showing configurable vs hardcoded parameters",
    "Add cross-references to Configuration chapter for general configuration patterns"
  ],
  "metadata": {
    "analyzed_at": "2025-01-06",
    "feature_inventory": ".prodigy/book-analysis/features.json",
    "topics_covered": [
      "Circular dependency detection",
      "Coupling metrics (afferent, efferent)",
      "Bidirectional dependencies",
      "Stable dependencies principle",
      "Zone of pain detection",
      "Zone of uselessness detection",
      "Code duplication detection",
      "Refactoring recommendations"
    ],
    "validation_focus": "Check that architectural pattern detection and coupling analysis are documented",
    "implementation_files_verified": [
      "src/debt/circular.rs",
      "src/debt/coupling.rs",
      "src/debt/duplication.rs",
      "src/core/mod.rs (DebtType enum)",
      "src/cli.rs"
    ]
  }
}
