{
  "chapter_id": "compare-analysis",
  "chapter_title": "Compare Analysis",
  "chapter_file": "book/src/compare-analysis.md",
  "drift_detected": true,
  "severity": "critical",
  "quality_assessment": "Chapter contains severe outdated information - claims core features are 'planned' when they are fully implemented. This will confuse users and prevent them from using available functionality.",
  "issues": [
    {
      "type": "outdated_information",
      "severity": "critical",
      "section": "Implementation Status (lines 5-24)",
      "description": "Chapter claims target location tracking, fuzzy matching, improvement percentages, and markdown/terminal output are 'Planned Features (Coming Soon)' when they are FULLY IMPLEMENTED",
      "current_content": "**Planned Features (Coming Soon)**:\n- ðŸš§ Target location tracking with fuzzy matching\n- ðŸš§ Detailed improvement percentage calculations (per-item)\n- ðŸš§ Markdown and terminal output formats\n- ðŸš§ Implementation plan parsing for target extraction\n- ðŸš§ Match strategies (Exact, FuzzyFunction, FuzzyFile)",
      "should_be": "All these features are implemented and available now. The CLI accepts --plan, --target-location, and --format options. ComparisonResult type includes all planned fields.",
      "fix_suggestion": "Move all 'planned' features to 'Current Implementation' section. Remove all warning boxes claiming features are under development. Update examples to show actual usage.",
      "source_reference": "src/cli.rs:401-427 (Compare command with all options), src/comparison/types.rs (ComparisonResult with all fields), src/comparison/location_matcher.rs (MatchStrategy enum with Exact, FunctionLevel, ApproximateName, FileLevel)"
    },
    {
      "type": "outdated_information",
      "severity": "critical",
      "section": "Target Location Tracking (lines 62-139)",
      "description": "Entire section marked as 'Planned Feature' with warning box, but target location tracking is fully implemented",
      "current_content": "> **âš ï¸ Planned Feature**: Target location tracking with fuzzy matching is currently under development.",
      "should_be": "Target location tracking is fully implemented. Users can specify --plan or --target-location and get TargetComparison results with match strategy and confidence.",
      "fix_suggestion": "Remove warning box. Update section to show it's a current feature. Correct match strategy names to match implementation (Exact, FunctionLevel, ApproximateName, FileLevel).",
      "source_reference": "src/comparison/location_matcher.rs:pub enum MatchStrategy"
    },
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Matching Strategies table (lines 118-127)",
      "description": "Match strategy names don't match implementation. Chapter shows 'Exact, FuzzyFunction, FuzzyFile' but code has 'Exact, FunctionLevel, ApproximateName, FileLevel'",
      "current_content": "| Strategy | When Used | Confidence |\n|----------|-----------|------------|\n| **Exact** | Location matches exactly | 1.0 |\n| **FuzzyFunction** | Function moved but name unchanged | 0.8 - 0.95 |\n| **FuzzyFile** | File changed but function exists | 0.6 - 0.8 |",
      "should_be": "| Strategy | When Used | Confidence |\n|----------|-----------|------------|\n| **Exact** | file:function:line matches exactly | 1.0 |\n| **FunctionLevel** | file:function matches (any line) | 0.8 |\n| **ApproximateName** | Fuzzy name matching | 0.6 |\n| **FileLevel** | All items in file | 0.4 |",
      "fix_suggestion": "Update table to match actual MatchStrategy enum variants and their confidence scores from the implementation.",
      "source_reference": "src/comparison/location_matcher.rs:13-18 (MatchStrategy enum), src/comparison/location_matcher.rs:42-47 (confidence scoring)"
    },
    {
      "type": "outdated_information",
      "severity": "critical",
      "section": "Before/After Metrics (lines 327-399)",
      "description": "Section claims detailed target metrics are 'Planned Feature' when TargetMetrics and ImprovementMetrics are fully implemented",
      "current_content": "> **âš ï¸ Planned Feature**: Detailed target item tracking with before/after metrics is under development.\n\n### Planned: Target Metrics Structure\n\nFuture versions will support detailed target item comparison:",
      "should_be": "This is a current feature. TargetComparison includes before/after TargetMetrics with score, cyclomatic_complexity, cognitive_complexity, coverage, function_length, nesting_depth plus ImprovementMetrics with percentage calculations.",
      "fix_suggestion": "Remove 'Planned' prefix and warning box. Show this as current functionality. The exact JSON structure shown is already returned by the compare command.",
      "source_reference": "src/comparison/types.rs:32-62 (TargetComparison, TargetMetrics, ImprovementMetrics structs)"
    },
    {
      "type": "outdated_information",
      "severity": "critical",
      "section": "Output Formats - Markdown (lines 469-484)",
      "description": "Claims markdown format is 'Coming Soon' when it's fully implemented in OutputFormat enum and used by compare command",
      "current_content": "> **ðŸš§ Coming Soon**: Markdown output format for human-readable reports.\n\nPlanned for pull request comments and documentation:",
      "should_be": "Markdown output format is available now via --format markdown option.",
      "fix_suggestion": "Remove 'Coming Soon' warning. Show actual usage with real markdown output examples. The CLI accepts markdown as a format option.",
      "source_reference": "src/cli.rs:421-422 (format: OutputFormat enum with Json, Markdown, Terminal variants)"
    },
    {
      "type": "incorrect_example",
      "severity": "high",
      "section": "Command-Line Options table (lines 48-60)",
      "description": "Table lists --plan, --target-location, and --format options as 'Planned Options (not yet implemented)' when they are implemented and documented in CLI",
      "current_content": "**Planned Options** (not yet implemented):\n- `--plan FILE` - Implementation plan to extract target location\n- `--target-location LOCATION` - Manual target location\n- `--format FORMAT` - Output format (markdown, terminal)",
      "should_be": "All these options are implemented. Should be in main options table, not in 'Planned' section.",
      "fix_suggestion": "Move these options to the main 'Command-Line Options' table. Add them as available options with proper descriptions. Remove 'not yet implemented' disclaimer.",
      "source_reference": "src/cli.rs:411-426 (plan, target_location, format, output options all present)"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Matching Strategies",
      "description": "Chapter doesn't document all four match strategies - missing FunctionLevel and ApproximateName",
      "should_add": "Document all four MatchStrategy variants: Exact (1.0 confidence), FunctionLevel (0.8), ApproximateName (0.6), FileLevel (0.4). Explain when each is used.",
      "fix_suggestion": "Add complete documentation of all match strategies with examples of each. Explain the matching algorithm and confidence scoring.",
      "source_reference": "src/comparison/location_matcher.rs:13-18 (MatchStrategy enum with all variants)"
    },
    {
      "type": "incorrect_example",
      "severity": "medium",
      "section": "Regression Detection (lines 192-236)",
      "description": "Chapter shows two different output structures - ValidationResult and ComparisonResult - but compare command only returns ComparisonResult",
      "current_content": "**Current Output Structure** (ValidationResult):\n...\n\n**Planned Output Structure** (ComparisonResult):",
      "should_be": "The compare command returns ComparisonResult (not ValidationResult). ValidationResult is from the separate 'validate' command.",
      "fix_suggestion": "Clarify that compare command returns ComparisonResult. If showing ValidationResult, note it's from a different command. Don't label ComparisonResult as 'planned' - it's the actual current output.",
      "source_reference": "src/comparison/types.rs:4-22 (ComparisonResult struct), src/comparison/types.rs:105-110 (RegressionItem with location, score, debt_type, description)"
    },
    {
      "type": "incorrect_example",
      "severity": "medium",
      "section": "Improvement Tracking (lines 263-326)",
      "description": "Chapter shows ValidationResult format with string improvements array, but ComparisonResult uses ImprovementItem struct array",
      "current_content": "The current implementation provides improvements as human-readable strings in the ValidationResult:\n\n```json\n{\n  \"improvements\": [\n    \"2 high priority items resolved\",\n    \"Average complexity reduction: 35%\"\n  ]\n}\n```\n\n### Planned: Detailed Improvement Metrics",
      "should_be": "ComparisonResult.improvements is Vec<ImprovementItem> with location, before_score, after_score, and improvement_type fields. This is the current structure, not planned.",
      "fix_suggestion": "Remove 'Planned' section. Show actual ImprovementItem structure as current. Update examples to match ComparisonResult schema.",
      "source_reference": "src/comparison/types.rs:112-126 (ImprovementItem and ImprovementType)"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Critical Debt Threshold",
      "description": "Chapter states critical items have score >= 8.0, but implementation uses >= 60.0",
      "current_content": "Items with score â‰¥ 8.0 (critical threshold)",
      "should_be": "Items with score >= 60.0 (critical threshold according to ProjectMetrics)",
      "fix_suggestion": "Update all references to critical threshold from 8.0 to 60.0. Also document high_priority_items threshold as >= 40.0.",
      "source_reference": "src/comparison/types.rs:91-92 (critical_items: score >= 60, high_priority_items: score >= 40)"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Plan Parser Format",
      "description": "Chapter shows example implementation plan with target location, but doesn't document the exact parsing pattern",
      "should_add": "Document that plan parser looks for pattern '**Location**: file:function:line' in markdown files. Show exact format required.",
      "fix_suggestion": "Add subsection explaining plan parser implementation and the exact markdown pattern it matches.",
      "source_reference": "src/comparison/plan_parser.rs (extracts target location from implementation plan markdown)"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Improvement Threshold",
      "description": "Chapter mentions 30% improvement threshold but doesn't clearly state this is configurable or hardcoded",
      "should_add": "Clarify that 30% score reduction is the hardcoded threshold for 'Improved' status. Items with less improvement are classified as 'Unchanged'.",
      "fix_suggestion": "Add note about improvement threshold and when items are classified as Improved vs Unchanged.",
      "source_reference": "src/comparison/comparator.rs (uses 30% threshold for improvement detection)"
    }
  ],
  "positive_aspects": [
    "Comprehensive examples showing CI/CD integration",
    "Good progression from basic to advanced usage",
    "Helpful troubleshooting section",
    "Clear explanations of concepts like debt trends and regression detection",
    "Well-structured with good use of tables and code examples",
    "Practical bash script examples (Example 5, 6)"
  ],
  "improvement_suggestions": [
    "Update entire chapter to reflect that ALL features are implemented and available",
    "Remove all 'Planned Feature' and 'Coming Soon' warnings",
    "Correct match strategy names to match implementation (Exact, FunctionLevel, ApproximateName, FileLevel)",
    "Fix critical threshold from 8.0 to 60.0 throughout",
    "Clarify difference between compare command (returns ComparisonResult) and validate command (returns ValidationResult)",
    "Add high_priority_items threshold documentation (>= 40.0)",
    "Show actual ComparisonResult JSON structure, not ValidationResult",
    "Update command-line options table to include all implemented options",
    "Add real examples of markdown and terminal format output",
    "Document plan parser markdown pattern requirements",
    "Add section on ImprovementType enum values and their meanings"
  ],
  "metadata": {
    "analyzed_at": "2025-11-06",
    "feature_inventory": "Derived from source code analysis (src/cli.rs, src/comparison/*.rs)",
    "topics_covered": [
      "Compare command usage",
      "Target location tracking",
      "Project health trends",
      "Regression detection",
      "Before/after metrics comparison",
      "Improvement percentage calculations",
      "Integration with CI/CD"
    ],
    "validation_focus": "Check that compare command features and workflow integration are documented"
  }
}
