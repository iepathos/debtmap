{
  "chapter_id": "entropy-analysis",
  "chapter_title": "Entropy Analysis",
  "chapter_file": "book/src/entropy-analysis.md",
  "drift_detected": true,
  "severity": "medium",
  "quality_assessment": "Chapter provides good conceptual overview but has inconsistencies with actual implementation details, particularly in configuration defaults and the dampening formula",
  "issues": [
    {
      "type": "outdated_information",
      "severity": "high",
      "section": "Configuration - weight default",
      "description": "Chapter shows entropy weight default as 0.5, but implementation uses 1.0",
      "current_content": "[entropy]\nweight = 0.5",
      "should_be": "[entropy]\nweight = 1.0",
      "fix_suggestion": "Update default weight value to 1.0 to match actual implementation in src/config.rs:1420",
      "source_reference": "src/config.rs:1420 - fn default_entropy_weight() -> f64 { 1.0 }"
    },
    {
      "type": "outdated_information",
      "severity": "high",
      "section": "Configuration - min_tokens default",
      "description": "Chapter shows min_tokens default as 10, but implementation uses 20",
      "current_content": "min_tokens = 10",
      "should_be": "min_tokens = 20",
      "fix_suggestion": "Update min_tokens default value to 20 to match implementation",
      "source_reference": "src/config.rs:1424 - fn default_entropy_min_tokens() -> usize { 20 }"
    },
    {
      "type": "outdated_information",
      "severity": "high",
      "section": "Configuration - entropy_threshold default",
      "description": "Chapter shows entropy_threshold default as 0.5, but implementation uses 0.4",
      "current_content": "entropy_threshold = 0.5",
      "should_be": "entropy_threshold = 0.4",
      "fix_suggestion": "Update entropy_threshold default value to 0.4 to match implementation",
      "source_reference": "src/config.rs:2267 (test) - assert_eq!(config.entropy_threshold, 0.4)"
    },
    {
      "type": "outdated_information",
      "severity": "high",
      "section": "Configuration - branch_threshold default",
      "description": "Chapter shows branch_threshold default as 0.7, but implementation uses 0.8",
      "current_content": "branch_threshold = 0.7",
      "should_be": "branch_threshold = 0.8",
      "fix_suggestion": "Update branch_threshold default value to 0.8 to match implementation",
      "source_reference": "src/config.rs:2268 (test) - assert_eq!(config.branch_threshold, 0.8)"
    },
    {
      "type": "missing_content",
      "severity": "high",
      "section": "Configuration",
      "description": "Chapter doesn't document max_repetition_reduction, max_entropy_reduction, max_branch_reduction fields",
      "should_add": "max_repetition_reduction = 0.20\nmax_entropy_reduction = 0.15\nmax_branch_reduction = 0.25",
      "fix_suggestion": "Add these fields to the configuration documentation section with their actual defaults",
      "source_reference": "src/config.rs:1382-1390 and tests at 2269-2272"
    },
    {
      "type": "incorrect_example",
      "severity": "medium",
      "section": "Configuration - max_combined_reduction",
      "description": "Chapter shows max_combined_reduction default as 0.7 (70%), but implementation uses 0.30 (30%)",
      "current_content": "max_combined_reduction = 0.7",
      "should_be": "max_combined_reduction = 0.30",
      "fix_suggestion": "Update max_combined_reduction to 0.30 to match actual default",
      "source_reference": "src/config.rs:2272 - assert_eq!(config.max_combined_reduction, 0.30)"
    },
    {
      "type": "outdated_information",
      "severity": "high",
      "section": "Effective Complexity Adjustment Formula",
      "description": "Chapter describes a complex weighted formula, but actual implementation (spec 68) uses simpler graduated dampening only for very low entropy (<0.2)",
      "current_content": "Effective Complexity = Raw Complexity × (1 - Entropy Adjustment)\n\nEntropy Adjustment = min(\n    max_reduction,\n    (1 - shannon_entropy) × weight +\n    pattern_repetition × weight +\n    branch_similarity × weight\n)",
      "should_be": "Only applies for very low entropy (<0.2) with graduated dampening:\ndampening_factor = (0.5 + 0.5 × (entropy / 0.2)).max(0.5)\nEffective Complexity = Raw Complexity × dampening_factor",
      "fix_suggestion": "Update formula section to reflect spec 68 implementation: only dampens when entropy < 0.2, with 50-100% preservation",
      "source_reference": "src/complexity/entropy.rs:1025-1047 - apply_entropy_dampening function"
    },
    {
      "type": "outdated_information",
      "severity": "medium",
      "section": "Example calculation",
      "description": "Example shows entropy adjustment reducing complexity from 20 to 6 (70% reduction), but actual implementation limits reduction to 50% maximum",
      "current_content": "Effective Complexity = 20 × (1 - 0.7) = 6",
      "should_be": "Maximum 50% reduction, so minimum result would be 10 for input of 20",
      "fix_suggestion": "Update example to show realistic reduction within spec 68 constraints (50% maximum)",
      "source_reference": "src/complexity/entropy.rs:1040-1046 - graduated dampening ensures max 50% reduction"
    },
    {
      "type": "missing_content",
      "severity": "medium",
      "section": "Implementation details",
      "description": "Chapter doesn't mention spec 68 or the specific threshold (<0.2) for when dampening applies",
      "should_add": "Entropy dampening only applies when token_entropy < 0.2 (very low entropy). For normal/high entropy (>= 0.2), no dampening is applied.",
      "fix_suggestion": "Add section explaining when dampening applies and reference to spec 68",
      "source_reference": "src/complexity/entropy.rs:1032-1035 - Spec 68 comments and threshold check"
    },
    {
      "type": "missing_content",
      "severity": "low",
      "section": "Token Classification",
      "description": "Chapter describes token weights but doesn't mention the use_classification configuration option",
      "should_add": "Document use_classification option that enables/disables weighted token classification",
      "fix_suggestion": "Add note about use_classification config option and its effect on entropy calculation",
      "source_reference": "src/config.rs:1373-1375 - use_classification field documentation"
    },
    {
      "type": "incomplete_explanation",
      "severity": "low",
      "section": "CLI flag",
      "description": "Chapter mentions --semantic-off flag but doesn't explain relationship to entropy analysis",
      "current_content": "debtmap analyze . --semantic-off",
      "should_be": "Explain that --semantic-off disables entropy-based complexity adjustments",
      "fix_suggestion": "Clarify what semantic analysis includes (entropy + other features)",
      "source_reference": "Features.json indicates semantic-off is separate from entropy config"
    }
  ],
  "positive_aspects": [
    "Clear motivation and problem statement (repetitive vs diverse complexity)",
    "Good conceptual explanation of Shannon entropy",
    "Excellent real-world examples (validation function vs state machine)",
    "Well-organized structure with progressive detail",
    "Helpful comparison table at the end",
    "Good explanation of token classification by importance",
    "Pattern repetition and branch similarity concepts are well explained",
    "Chapter includes configuration examples and tuning guidance",
    "Best practices section provides actionable advice"
  ],
  "improvement_suggestions": [
    "Align all configuration defaults with actual implementation",
    "Update formula section to match spec 68 implementation (graduated dampening for entropy < 0.2)",
    "Add section on implementation architecture (entropy_analysis.rs, entropy_core.rs, entropy.rs modules)",
    "Include more details on weighted vs non-weighted entropy calculation",
    "Explain the relationship between entropy dampening and other semantic features",
    "Add troubleshooting section for unexpected dampening behavior",
    "Include examples showing the 0.2 threshold behavior",
    "Document the caching mechanism for entropy scores",
    "Update example calculations to reflect actual implementation constraints"
  ],
  "metadata": {
    "analyzed_at": "2025-10-25",
    "feature_inventory": ".debtmap/book-analysis/features.json",
    "topics_covered": [
      "Shannon entropy calculation",
      "Pattern repetition detection",
      "Branch similarity analysis",
      "Token classification",
      "Effective complexity adjustment",
      "Configuration options",
      "False positive reduction"
    ],
    "validation_focus": "Check that entropy analysis algorithm, components, and configuration are documented with examples",
    "key_source_files": [
      "src/complexity/entropy.rs",
      "src/complexity/entropy_analysis.rs",
      "src/complexity/entropy_core.rs",
      "src/config.rs"
    ]
  }
}
